<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CivicTrack Admin</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='admin.css') }}">
</head>
<body>
    <div class="container">
        <!-- Sidebar -->
        <nav class="sidebar">
            <ul>
                <li><a href="#" class="nav-item active" onclick="showSection('dashboard', event)"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="#" class="nav-item" onclick="showSection('analysis', event)"><i class="fas fa-chart-bar"></i> Analysis</a></li>
                <li><a href="#" class="nav-item" onclick="showSection('user-management', event)"><i class="fas fa-users"></i> User Management</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <div class="main-content">
            <div class="page-header">
                <h1 id="page-title">Dashboard</h1>
            </div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="content-section active">
                <h2>All Issues</h2>
                
                <div class="table-container">
                    <table class="issues-table">
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Title</th>
                                <th>Status</th>
                                <th>Category</th>
                                <th>Description</th>
                                <th>Date Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for issue in issues %}
                            <tr>
                                <td>{{ issue.id }}</td>
                                <td>{{ issue.title }}</td>
                                <td><span class="status-badge status-{{ issue.status.lower().replace('-', '') }}">{{ issue.status }}</span></td>
                                <td>{{ issue.category }}</td>
                                <td>{{ issue.description[:50] }}{% if issue.description|length > 50 %}...{% endif %}</td>
                                <td class="action-cell">
                                    <a href="{{ url_for('view_issue', issue_id=issue.id) }}" class="action-btn view-btn">View</a>
                                    <form action="{{ url_for('change_status', issue_id=issue.id) }}" method="POST" style="display: inline;">
                                        <select name="status" class="status-select-table" onchange="this.form.submit()">
                                            <option value="Posted" {% if issue.status == 'Posted' %}selected{% endif %}>Posted</option>
                                            <option value="Reported" {% if issue.status == 'Reported' %}selected{% endif %}>Reported</option>
                                            <option value="In-Progress" {% if issue.status == 'In-Progress' %}selected{% endif %}>In-Progress</option>
                                            <option value="Resolved" {% if issue.status == 'Resolved' %}selected{% endif %}>Resolved</option>
                                        </select>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                <!-- Template logic would go here -->
                <!-- 
                
                -->
            </div>

            <!-- Analysis Section -->
            <div id="analysis" class="content-section">
                <h2>Issue Analytics</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number">5</div>
                        <div class="stat-label">Total Issues</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">1</div>
                        <div class="stat-label">Flagged</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">2</div>
                        <div class="stat-label">Resolved</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number">3</div>
                        <div class="stat-label">In Progress</div>
                    </div>
                </div>

                <div class="categories-section">
                    <h2 class="categories-title">Most Reported Categories</h2>
                    
                    {% for category, count in category_dict.items() %}
                    <div class="category-item">
                        <div class="category-name">{{ category }}</div>
                        <div class="category-bar-container">
                            <div class="category-bar">{{ count }}</div>
                        </div>
                        <div class="category-count">{{ count }}</div>
                    </div>
                    {% endfor %}

                    <!-- Template logic would go here -->
                    <!--  -->
                </div>
            </div>

            <!-- User Management Section -->
            <div id="user-management" class="content-section">
                <h2>User Management</h2>
                
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Search issues..." onkeyup="searchUsers(this.value)">
                </div>
 
                <div class="table-container">
                    <table class="users-table">
                        <thead>
                            <tr>
                                <th>Issue ID</th>
                                <th>Title</th>
                                <th>User</th>
                                <th>Email</th>
                                <th>Flags</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="usersList">
                            {% for issue in issues %}
                            <tr class="user-item">
                                <td>{{ issue.id }}</td>
                                <td>{{ issue.title }}</td>
                                <td>{{ issue.user.name if issue.user else 'Unknown' }}</td>
                                <td>{{ issue.user.email if issue.user else 'N/A' }}</td>
                                <td><span class="flag-count {% if issue.flags|length == 0 %}flag-none{% elif issue.flags|length > 3 %}flag-high{% endif %}">{{ issue.flags|length }}</span></td>
                                <td><span class="status-badge status-{{ issue.status.lower().replace('-', '') }}">{{ issue.status }}</span></td>
                                <td class="action-cell">
                                    <button class="action-btn flag-btn">View Flags</button>
                                    {% if issue.flags|length > 3 %}
                                        <button class="action-btn ban-btn">Ban User</button>
                                    {% else %}
                                        <button class="action-btn warn-btn">Warn User</button>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Flag Details Modal -->
    <div class="modal-overlay" id="flagModal">
        <div class="flag-modal">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Flag Details</h2>
                <button class="close-btn" onclick="closeFlagModal()">Ã—</button>
            </div>
            <div id="flagContent">
                <!-- Flag details will be populated here -->
            </div>
        </div>
    </div>

    <script>
        function showSection(sectionId, event) {
            // Hide all sections
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });

            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            // Show selected section
            document.getElementById(sectionId).classList.add('active');

            // Add active class to clicked nav item
            event.target.classList.add('active');

            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'analysis': 'Issue Analytics',
                'user-management': 'User Management'
            };
            document.getElementById('page-title').textContent = titles[sectionId];
        }

        function searchUsers(query) {
            const usersList = document.getElementById('usersList');
            const userItems = usersList.getElementsByClassName('user-item');
            
            for (let item of userItems) {
                const text = item.textContent.toLowerCase();
                if (text.includes(query.toLowerCase())) {
                    item.style.display = 'table-row';
                } else {
                    item.style.display = 'none';
                }
            }
        }

        function viewFlags(issueId) {
            // Sample flag data - replace with actual data from your backend
            const flagData = {
                1: [
                    { reason: 'Inappropriate Language', reporter: 'user123', date: '2025-08-01' },
                    { reason: 'Spam', reporter: 'user456', date: '2025-08-02' }
                ],
                2: [],
                3: [
                    { reason: 'False Information', reporter: 'user789', date: '2025-07-29' }
                ],
                4: [
                    { reason: 'Inappropriate Language', reporter: 'user111', date: '2025-08-01' },
                    { reason: 'Spam', reporter: 'user222', date: '2025-08-01' },
                    { reason: 'Harassment', reporter: 'user333', date: '2025-08-02' },
                    { reason: 'False Information', reporter: 'user444', date: '2025-08-02' },
                    { reason: 'Inappropriate Content', reporter: 'user555', date: '2025-08-02' }
                ]
            };

            const flags = flagData[issueId] || [];
            const modal = document.getElementById('flagModal');
            const content = document.getElementById('flagContent');
            const title = document.getElementById('modalTitle');

            title.textContent = `Flags for Issue #${issueId}`;

            if (flags.length === 0) {
                content.innerHTML = '<p>No flags reported for this issue.</p>';
            } else {
                let flagsHtml = '<div class="flags-list">';
                flags.forEach((flag, index) => {
                    flagsHtml += `
                        <div class="flag-item">
                            <div class="flag-header">
                                <strong>Flag #${index + 1}</strong>
                                <span class="flag-date">${flag.date}</span>
                            </div>
                            <div class="flag-reason"><strong>Reason:</strong> ${flag.reason}</div>
                            <div class="flag-reporter"><strong>Reported by:</strong> ${flag.reporter}</div>
                        </div>
                    `;
                });
                flagsHtml += '</div>';
                content.innerHTML = flagsHtml;
            }

            modal.style.display = 'flex';
        }

        function updateStatus(selectElement) {
            const newStatus = selectElement.value;
            // Here you would typically make an AJAX call to update the status
            console.log('Status updated to:', newStatus);
            
            // Show a simple notification
            const notification = document.createElement('div');
            notification.textContent = `Status updated to: ${newStatus}`;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: #28a745;
                color: white;
                padding: 1rem 2rem;
                border-radius: 5px;
                z-index: 1001;
            `;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                document.body.removeChild(notification);
            }, 3000);
        }

        function closeFlagModal() {
            document.getElementById('flagModal').style.display = 'none';
        }

        // Close modal when clicking outside
        document.getElementById('flagModal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeFlagModal();
            }
        });
    </script>
</body>
</html>